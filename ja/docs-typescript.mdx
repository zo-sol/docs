---
title: "開発者向けドキュメント"
description: "IQLabs SDK の主要な概念と関数"
---

<Note>
このドキュメントは作成中で、今後改善されます。
</Note>

## インストール

```bash
npm i @iqlabs-official/solana-sdk
```

---

## コア概念

これらは IQLabs SDK を使う前に知っておくべき主要な概念です。

---

### データストレージ（Code In）

あらゆるデータ（ファイル、テキスト、JSON）をオンチェーンに保存する方法です。

#### どのように保存されますか？

データサイズに応じて、SDK が最適な方法を選びます。

- **小容量データ (&lt; 900 bytes)**：すぐに保存、最速
- **中容量データ (&lt; 8.5 KB)**：複数のトランザクションに分割
- **大容量データ (&gt;= 8.5 KB)**：速度向上のため並列アップロード

#### 関連する主要関数

- [`codeIn()`](#codein)：データをアップロードしてトランザクション ID を取得
- [`readCodeIn()`](#readcodein)：トランザクション ID からデータを読み戻す

---

### ユーザー状態 PDA

ユーザーのためのオンチェーン・プロフィールアカウントです。

#### 何が保存されますか？

- プロフィール情報（名前、プロフィール画像、自己紹介 など）
- アップロードされたファイル数
- フレンドリクエストの記録

<Note>
フレンドリクエストは PDA の値として保存されず、トランザクションとして送信されます。
</Note>

#### いつ作成されますか？

[`codeIn()`](#codein) を初めて呼び出したときに自動で作成されます。追加の設定は不要ですが、最初のユーザーは 2 回署名が必要な場合があります。

---

### 接続 PDA

2 人のユーザー間の関係（友だち、メッセージ など）を管理するオンチェーンアカウントです。

#### どの状態になれますか？

- **pending**：フレンドリクエストが送信されたが、まだ承認されていない
- **approved**：リクエストが承認され、ユーザーが接続済み
- **blocked**：どちらかが相手をブロックした

<Warning>
ブロックされた接続は、ブロックした側だけが解除できます。
</Warning>

#### 関連する主要関数

- [`requestConnection()`](#requestconnection)：フレンドリクエストを送信（pending を作成）
- [`manageConnection()`](#manageconnection)：リクエストの承認/拒否/ブロック/解除
- [`readConnection()`](#readconnection)：現在の関係ステータスを確認
- [`writeConnectionRow()`](#writeconnectionrow)：接続済みの友だちとメッセージ/データを交換
- [`fetchUserConnections()`](#fetchuserconnections)：すべての接続（送信・受信したリクエスト）を取得

---

### データベーステーブル

JSON データをデータベースのようにテーブルへ保存します。

#### テーブルはどう作成されますか？

専用の「create table」関数はありません。[`writeRow()`](#writerow) による最初の書き込みが自動的にテーブルを作成します。

<Note>
テーブルは `dbRootId` と `tableSeed`（テーブル名）の組み合わせで一意に識別されます。
</Note>

#### 関連する主要関数

- [`writeRow()`](#writerow)：新しい行を追加（テーブルがなければ作成）
- [`readTableRows()`](#readtablerows)：テーブルの行を読み取る
- [`getTablelistFromRoot()`](#gettablelistfromroot)：データベース内の全テーブルを一覧表示
- [`fetchInventoryTransactions()`](#fetchinventorytransactions)：アップロード済みファイルを一覧表示

---

## 関数の詳細

### データの保存と取得

#### `codeIn()`

| **パラメータ** | `input`: `{ connection, signer }` オブジェクト<br/>`data`: アップロードするデータ（string または string[]）<br/>`filename`: 任意のファイル名（string）<br/>`method`: アップロード方法（number、デフォルト: 0）<br/>`filetype`: ファイルタイプヒント（string、デフォルト: ''）<br/>`onProgress`: 任意の進捗コールバック `(percent: number) => void` |
|----------------|--------------------------|
| **戻り値** | トランザクション署名（string） |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

// データをアップロード
const signature = await iqlabs.writer.codeIn(
  { connection, signer },
  'Hello, blockchain!'
);

// ファイル名付きでアップロード
const sig = await iqlabs.writer.codeIn(
  { connection, signer },
  'file contents here',
  'hello.txt'
);
```

---

#### `readCodeIn()`

| **パラメータ** | `txSignature`: トランザクション署名（string）<br/>`speed`: レート制限プロファイル（任意、'light' \| 'medium' \| 'heavy' \| 'extreme'）<br/>`onProgress`: 任意の進捗コールバック `(percent: number) => void` |
|----------------|--------------------------|
| **戻り値** | `{ metadata: string, data: string \| null }` |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const result = await iqlabs.reader.readCodeIn('5Xg7...');
console.log(result.data);      // 'Hello, blockchain!'
console.log(result.metadata);  // ファイルメタデータを含む JSON 文字列
```

---

### 接続管理

#### `requestConnection()`

| **パラメータ** | `connection`: Solana RPC 接続<br/>`signer`: 署名者<br/>`dbRootId`: データベース ID（Uint8Array または string）<br/>`partyA`: 最初のユーザーの公開鍵（string）<br/>`partyB`: 2番目のユーザーの公開鍵（string）<br/>`tableName`: 接続テーブル名（string または Uint8Array）<br/>`columns`: 列リスト（Array\<string \| Uint8Array\>）<br/>`idCol`: ID 列（string または Uint8Array）<br/>`extKeys`: 拡張キー（Array\<string \| Uint8Array\>） |
|----------------|--------------------------|
| **戻り値** | トランザクション署名（string） |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

await iqlabs.writer.requestConnection(
  connection, signer, 'my-db',
  myWalletAddress, friendWalletAddress,
  'dm_table', ['message', 'timestamp'], 'message_id', []
);
```

---

#### `manageConnection()`

<Note>
この関数には高レベルの SDK ラッパーがありません。コントラクトレベルのインストラクションビルダーを直接使用してください。
</Note>

| **パラメータ** | `builder`: InstructionBuilder<br/>`accounts`: `{ db_root, connection_table, signer }`（PublicKey）<br/>`args`: `{ db_root_id, connection_seed, new_status }` |
|----------------|--------------------------|
| **戻り値** | TransactionInstruction |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const builder = iqlabs.contract.createInstructionBuilder(iqlabs.contract.PROGRAM_ID);

// フレンドリクエストを承認
const approveIx = iqlabs.contract.manageConnectionInstruction(
  builder,
  { db_root, connection_table, signer: myPubkey },
  { db_root_id, connection_seed, new_status: iqlabs.contract.CONNECTION_STATUS_APPROVED }
);

// ユーザーをブロック
const blockIx = iqlabs.contract.manageConnectionInstruction(
  builder,
  { db_root, connection_table, signer: myPubkey },
  { db_root_id, connection_seed, new_status: iqlabs.contract.CONNECTION_STATUS_BLOCKED }
);
```

---

#### `readConnection()`

| **パラメータ** | `dbRootId`: データベース ID（Uint8Array または string）<br/>`partyA`: 最初のウォレット（string）<br/>`partyB`: 2番目のウォレット（string） |
|----------------|--------------------------|
| **戻り値** | `{ status: 'pending' \| 'approved' \| 'blocked' \| 'unknown', requester: 'a' \| 'b', blocker: 'a' \| 'b' \| 'none' }` |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const { status, requester, blocker } = await iqlabs.reader.readConnection('my-db', partyA, partyB);
console.log(status); // 'pending' | 'approved' | 'blocked'
```

---

#### `writeConnectionRow()`

| **パラメータ** | `connection`: Solana RPC 接続<br/>`signer`: 署名者<br/>`dbRootId`: データベース ID（Uint8Array または string）<br/>`connectionSeed`: 接続シード（Uint8Array または string）<br/>`rowJson`: JSON データ（string） |
|----------------|--------------------------|
| **戻り値** | トランザクション署名（string） |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

await iqlabs.writer.writeConnectionRow(
  connection, signer, 'my-db', connectionSeed,
  JSON.stringify({ message_id: '123', message: 'Hello friend!', timestamp: Date.now() })
);
```

---

#### `fetchUserConnections()`

UserState PDA のトランザクション履歴を解析して、ユーザーのすべての接続（フレンドリクエスト）を取得します。各接続には、その接続が属するアプリを示す `dbRootId` が含まれます。

| **パラメータ** | `userPubkey`: ユーザー公開鍵（string または PublicKey）<br/>`options`: 任意の設定 |
|----------------|--------------------------|
| **オプション** | `limit`: 取得するトランザクションの最大数<br/>`before`: ページネーション開始の署名<br/>`speed`: レート制限プロファイル（'light' \| 'medium' \| 'heavy' \| 'extreme'） |
| **戻り値** | `{ dbRootId, connectionPda, partyA, partyB, status, requester, blocker, timestamp }` の配列 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const connections = await iqlabs.reader.fetchUserConnections(myPubkey, {
  speed: 'light',
  limit: 100
});

// ステータスでフィルタ
const pendingRequests = connections.filter(c => c.status === 'pending');
const friends = connections.filter(c => c.status === 'approved');
const blocked = connections.filter(c => c.status === 'blocked');

// 接続の詳細を確認
connections.forEach(conn => {
  console.log(`${conn.partyA} <-> ${conn.partyB}, status: ${conn.status}`);
});
```

---

### テーブル管理

#### `writeRow()`

| **パラメータ** | `connection`: Solana RPC 接続<br/>`signer`: 署名者<br/>`dbRootId`: データベース ID（Uint8Array または string）<br/>`tableSeed`: テーブル名（Uint8Array または string）<br/>`rowJson`: JSON 行データ（string）<br/>`skipConfirmation`: トランザクション確認をスキップ（boolean、デフォルト: false） |
|----------------|--------------------------|
| **戻り値** | トランザクション署名（string） |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

// 最初の行を書き込み、テーブルを作成
await iqlabs.writer.writeRow(connection, signer, 'my-db', 'users', JSON.stringify({
  id: 1, name: 'Alice', email: 'alice@example.com'
}));

// 同じテーブルに別の行を追加
await iqlabs.writer.writeRow(connection, signer, 'my-db', 'users', JSON.stringify({
  id: 2, name: 'Bob', email: 'bob@example.com'
}));
```

---

#### `readTableRows()`

| **パラメータ** | `account`: テーブル PDA（PublicKey または string）<br/>`options`: 任意の設定 |
|----------------|--------------------------|
| **オプション** | `limit`: 取得する行の最大数<br/>`before`: ページネーション用署名カーソル<br/>`signatures`: 事前収集した署名配列（指定時は RPC 取得をスキップ）<br/>`speed`: レート制限プロファイル（'light', 'medium', 'heavy', 'extreme'） |
| **戻り値** | `Array<Record<string, unknown>>` |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

// 基本的な使い方
const rows = await iqlabs.reader.readTableRows(tablePda, { limit: 50 });

// カーソルベースのページネーション
const olderRows = await iqlabs.reader.readTableRows(tablePda, { limit: 50, before: 'sig...' });

// 事前収集した署名を使用（署名取得をスキップし、直接デコード）
const sigs = await iqlabs.reader.collectSignatures(tablePda);
const targetIdx = sigs.indexOf('abc123');
const slice = sigs.slice(targetIdx - 25, targetIdx + 25);
const rows = await iqlabs.reader.readTableRows(tablePda, { signatures: slice });
```

---

#### `collectSignatures()`

アカウントのすべて（または `maxSignatures` 件まで）のトランザクション署名を収集します。軽量で、トランザクションのデコードは行わず、署名文字列のみを取得します。ページネーションに便利です：署名リスト全体を一度取得し、スライスして `readTableRows()` に渡します。

| **パラメータ** | `account`: テーブル PDA（PublicKey または string）<br/>`maxSignatures`: 収集する署名の最大数（任意、省略時はすべて取得） |
|----------------|--------------------------|
| **戻り値** | `string[]`（署名文字列） |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

// すべての署名を収集
const allSigs = await iqlabs.reader.collectSignatures(tablePda);

// 最大 3000 件の署名を収集
const sigs = await iqlabs.reader.collectSignatures(tablePda, 3000);

// readTableRows と組み合わせて途中から読み取る
const targetIdx = sigs.indexOf('abc123');
const chunk = sigs.slice(targetIdx - 25, targetIdx + 25);
const rows = await iqlabs.reader.readTableRows(tablePda, { signatures: chunk });
```

---

#### `getTablelistFromRoot()`

| **パラメータ** | `connection`: Solana RPC 接続<br/>`dbRootId`: データベース ID（Uint8Array または string） |
|----------------|--------------------------|
| **戻り値** | `{ rootPda: PublicKey, creator: string \| null, tableSeeds: string[], globalTableSeeds: string[] }` |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const result = await iqlabs.reader.getTablelistFromRoot(connection, 'my-db');
console.log('Creator:', result.creator);
console.log('Table seeds:', result.tableSeeds);
```

---

#### `fetchInventoryTransactions()`

| **パラメータ** | `publicKey`: ユーザー公開鍵（PublicKey）<br/>`limit`: 最大数（number）<br/>`before`: ページネーションカーソル（任意、string） |
|----------------|--------------------------|
| **戻り値** | トランザクション配列 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const myFiles = await iqlabs.reader.fetchInventoryTransactions(myPubkey, 20);
myFiles.forEach(tx => {
  let metadata: { data?: unknown } | null = null;
  try {
    metadata = JSON.parse(tx.metadata);
  } catch {
    metadata = null;
  }

  if (metadata && metadata.data !== undefined) {
    const inlineData = typeof metadata.data === 'string'
      ? metadata.data
      : JSON.stringify(metadata.data);
    console.log(`Inline data: ${inlineData}`);
  } else {
    console.log(`Signature: ${tx.signature}`);
  }
});
```

---

### 環境設定

#### `setRpcUrl()`

| **パラメータ** | `url`: Solana RPC の URL（string） |
|----------------|--------------------------|
| **戻り値** | void |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

iqlabs.utils.setRpcUrl('https://your-rpc.example.com');
```

---

## 高度な関数

<Warning>
これらは低レベルの SDK 関数です。通常の利用には不要ですが、カスタム機能の構築やデバッグに役立ちます。
</Warning>

### 書き込み関数

#### `manageRowData()`

テーブル行の書き込みと接続行の書き込みの両方を処理する統合関数です。既存の PDA に基づいて、テーブルまたは接続のどちらに書き込むかを自動検出します。

| **モジュール** | `writer` |
|------------|----------|
| **パラメータ** | `connection`: Solana RPC 接続<br/>`signer`: 署名者<br/>`dbRootId`: データベース ID（Uint8Array または string）<br/>`seed`: テーブルまたは接続シード（Uint8Array または string）<br/>`rowJson`: JSON 行データ（string）<br/>`tableName`: テーブル編集時に必要（任意、string または Uint8Array）<br/>`targetTx`: テーブル編集時の参照トランザクション（任意、string または Uint8Array） |
| **戻り値** | トランザクション署名（string） |
| **用途** | カスタム行管理、既存行の更新 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

await iqlabs.writer.manageRowData(
  connection, signer,
  'my-db',       // dbRootId
  'users',       // seed（テーブルシード）
  JSON.stringify({ id: 1, name: 'Updated Name' }),
  'users',       // tableName
  originalTxSig  // targetTx
);
```

---

### 読み取り関数

#### `readUserState()`

指定したユーザーの UserState PDA を読み取ります。

| **モジュール** | `reader` |
|------------|----------|
| **パラメータ** | `userPubkey`: ユーザー公開鍵（string） |
| **戻り値** | `{ owner: string, metadata: string \| null, totalSessionFiles: bigint, profileData?: string }` |
| **用途** | プロフィールデータの取得、アップロード数の確認 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const userState = await iqlabs.reader.readUserState(userPubkey);
console.log('Owner:', userState.owner);
console.log('Session files:', userState.totalSessionFiles);
console.log('Profile data:', userState.profileData);
```

---

#### `readInventoryMetadata()`

ユーザーのインベントリトランザクションに関連するメタデータを読み取ります。

| **モジュール** | `reader` |
|------------|----------|
| **パラメータ** | `txSignature`: トランザクション署名（string） |
| **戻り値** | `{ onChainPath: string, metadata: string }` |
| **用途** | インベントリトランザクションからのファイルメタデータ抽出 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const result = await iqlabs.reader.readInventoryMetadata(txSignature);
console.log('Path:', result.onChainPath);
console.log('Metadata:', result.metadata);
```

---

#### `getSessionPdaList()`

ユーザーのセッション PDA アドレスのリストを取得します。

| **モジュール** | `reader` |
|------------|----------|
| **パラメータ** | `userPubkey`: ユーザー公開鍵（string） |
| **戻り値** | `string[]`（セッション PDA の base58 文字列） |
| **用途** | セッション管理、アクティブセッションの追跡 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const sessions = await iqlabs.reader.getSessionPdaList(userPubkey);
sessions.forEach(pda => {
  console.log(`Session PDA: ${pda}`);
});
```

---

### ユーティリティ関数

#### `deriveDmSeed()`

2 人のユーザー間のダイレクトメッセージ（DM）用に決定的なシードを導出します。2 つの公開鍵をアルファベット順にソートし、keccak256 でハッシュします。

| **モジュール** | `utils` |
|------------|----------|
| **パラメータ** | `userA`: 最初のユーザーの公開鍵（string）<br/>`userB`: 2番目のユーザーの公開鍵（string） |
| **戻り値** | `Uint8Array`（シードバイト） |
| **用途** | 一貫した接続識別子の作成、DM チャネルの設定 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const seed1 = iqlabs.utils.deriveDmSeed(walletA, walletB);
const seed2 = iqlabs.utils.deriveDmSeed(walletB, walletA);
// seed1 と seed2 は同一 — 順序は関係ありません
```

---

#### `toSeedBytes()`

シード識別子をバイトに変換します。入力が 64 文字の 16 進数文字列の場合、16 進数バイトを直接返します。それ以外の場合は keccak256 ハッシュを適用します。

| **モジュール** | `utils` |
|------------|----------|
| **パラメータ** | `value`: シード文字列または Uint8Array |
| **戻り値** | `Uint8Array` |
| **用途** | カスタム PDA 導出、低レベルなシード操作 |

```typescript
import iqlabs from '@iqlabs-official/solana-sdk';

const seedString = 'my-custom-seed';
const seedBytes = iqlabs.utils.toSeedBytes(seedString);

const [pda, bump] = PublicKey.findProgramAddressSync(
  [seedBytes, otherSeed],
  programId
);
```
